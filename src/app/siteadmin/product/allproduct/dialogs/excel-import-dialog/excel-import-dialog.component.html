<div class="excel-import-dialog">
  <div class="dialog-header">
    <h2 mat-dialog-title>Import Products from Excel</h2>
    <button mat-icon-button (click)="close()" class="close-btn">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-dialog-content>
    <div class="import-container">
      <!-- Step 1: File Upload -->
      <div class="upload-section" *ngIf="parsedData.length === 0">
        <div class="upload-area" (click)="triggerFileInput()" (dragover)="$event.preventDefault()"
          (drop)="handleDrop($event)">
          <mat-icon class="upload-icon">cloud_upload</mat-icon>
          <h3>Upload Excel File</h3>
          <p>Click here or drag and drop your Excel file</p>
          <p class="file-info">Supported formats: .xlsx, .xls, .csv</p>
          <button mat-raised-button color="primary" (click)="triggerFileInput()">
            <mat-icon>folder_open</mat-icon>
            Choose File
          </button>
        </div>
        <input #fileInput type="file" accept=".xlsx,.xls,.csv" (change)="onFileSelected($event)" style="display: none" />

        <div class="template-section">
          <p>Don't have a template? Download one:</p>
          <button mat-stroked-button color="primary" (click)="downloadTemplate()">
            <mat-icon>download</mat-icon>
            Download Template
          </button>
        </div>
      </div>

      <!-- Step 2: Review Data -->
      <div class="review-section" *ngIf="parsedData.length > 0">
        <div class="section-header">
          <h3>Review Import Data</h3>
          <div class="actions">
            <button mat-stroked-button (click)="triggerFileInput()">
              <mat-icon>refresh</mat-icon>
              Change File
            </button>
            <button mat-stroked-button (click)="downloadTemplate()">
              <mat-icon>download</mat-icon>
              Template
            </button>
          </div>
        </div>

        <div class="summary-info">
          <div class="info-item">
            <span class="label">Total Products:</span>
            <span class="value">{{ parsedData.length }}</span>
          </div>
          <div class="info-item">
            <span class="label">Selected:</span>
            <span class="value">{{ selectedRows.size }}</span>
          </div>
          <div class="info-item">
            <span class="label">With Errors:</span>
            <span class="value error">
              {{ errorCount }}
            </span>
          </div>
        </div>

        <!-- Progress Bar -->
        <div *ngIf="isImporting" class="progress-section">
          <mat-progress-bar mode="determinate" [value]="importProgress"></mat-progress-bar>
          <p class="progress-text">Importing... {{ importProgress }}%</p>
        </div>

        <!-- Data Table -->
        <div class="table-container">
          <table mat-table [dataSource]="parsedData" class="import-table">
            <!-- Select Column -->
            <ng-container matColumnDef="select">
              <th mat-header-cell *matHeaderCellDef>
                <mat-checkbox (change)="toggleAllSelection()" [checked]="allSelected" color="primary">
                </mat-checkbox>
              </th>
              <td mat-cell *matCellDef="let row; let i = index">
                <mat-checkbox (change)="toggleRowSelection(i)" [checked]="selectedRows.has(i)"
                  [disabled]="hasErrors(i)" color="primary">
                </mat-checkbox>
              </td>
            </ng-container>

            <!-- Name Column -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Product Name</th>
              <td mat-cell *matCellDef="let row">
                <span [class.error-text]="!row.name">{{ row.name || 'N/A' }}</span>
              </td>
            </ng-container>

            <!-- SKU Column -->
            <ng-container matColumnDef="sku">
              <th mat-header-cell *matHeaderCellDef>SKU</th>
              <td mat-cell *matCellDef="let row">
                <span [class.error-text]="!row.sku">{{ row.sku || 'N/A' }}</span>
              </td>
            </ng-container>

            <!-- Price Column -->
            <ng-container matColumnDef="price">
              <th mat-header-cell *matHeaderCellDef>Price</th>
              <td mat-cell *matCellDef="let row">
                <span [class.error-text]="row.price === null || row.price === undefined">
                  ${{ row.price !== null && row.price !== undefined ? (row.price | number:'1.2-2') : 'N/A' }}
                </span>
              </td>
            </ng-container>

            <!-- Quantity Column -->
            <ng-container matColumnDef="quantity">
              <th mat-header-cell *matHeaderCellDef>Stock</th>
              <td mat-cell *matCellDef="let row">
                <span [class.error-text]="row.quantity === null || row.quantity === undefined">
                  {{ row.quantity !== null && row.quantity !== undefined ? row.quantity : 'N/A' }}
                </span>
              </td>
            </ng-container>

            <!-- Category Column -->
            <ng-container matColumnDef="category">
              <th mat-header-cell *matHeaderCellDef>Sub Category</th>
              <td mat-cell *matCellDef="let row">
                <span [class.error-text]="row.sub_category_name && !row.category_id">
                  {{ row.sub_category_name || 'N/A' }}
                </span>
              </td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let row">
                <span class="badge" [ngClass]="{
                  'badge-success': row.status,
                  'badge-danger': !row.status
                }">
                  {{ row.status ? 'Active' : 'Inactive' }}
                </span>
              </td>
            </ng-container>

            <!-- Errors Column -->
            <ng-container matColumnDef="errors">
              <th mat-header-cell *matHeaderCellDef>Errors</th>
              <td mat-cell *matCellDef="let row">
                <div *ngIf="row.errors && row.errors.length > 0" class="error-list">
                  <span *ngFor="let error of row.errors" class="error-badge">
                    {{ error }}
                  </span>
                </div>
                <span *ngIf="!row.errors || row.errors.length === 0" class="success-badge">âœ“ Valid</span>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" [class.error-row]="row.errors && row.errors.length > 0">
            </tr>
          </table>
        </div>
      </div>
    </div>
  </mat-dialog-content>

  <div class="dialog-actions" *ngIf="parsedData.length > 0">
    <button mat-button (click)="close()" [disabled]="isImporting">Cancel</button>
    <button mat-raised-button color="primary" (click)="importProducts()" [disabled]="isImporting || selectedRows.size === 0">
      <mat-icon>cloud_upload</mat-icon>
      Import Selected ({{ selectedRows.size }})
    </button>
  </div>
</div>
